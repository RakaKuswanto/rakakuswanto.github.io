<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Screener Performance Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0f172a;
            background-image: radial-gradient(#334155 1px, transparent 1px);
            background-size: 20px 20px;
            color: #d1d5db;
        }
        .loader {
            border-top-color: #10b981;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        ::-webkit-scrollbar { height: 6px; width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .fade-in { animation: fadeIn 0.5s ease-out forwards; }
    </style>
</head>
<body class="min-h-screen">

    <div class="max-w-screen-xl mx-auto p-4 sm:p-6 lg:p-8">
        <header class="mb-6 flex justify-between items-center">
            <div>
                <h1 class="text-2xl font-bold text-white">ðŸ“Š Screener Performance Dashboard</h1>
                <p id="last-updated" class="text-sm text-slate-400 mt-1"></p>
            </div>
            <div class="flex items-center gap-4">
                <button id="refresh-btn" class="p-2 rounded-full bg-slate-800 border border-slate-700 text-slate-400 hover:text-white hover:bg-slate-700 transition-all duration-200">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0l3.181 3.183a8.25 8.25 0 0011.664 0l3.18-3.185m-3.181 9.348a8.25 8.25 0 00-11.664 0l-3.18 3.185m3.181-9.348h4.992" /></svg>
                </button>
                <a href="https://github.com" target="_blank" class="text-slate-400 hover:text-white transition-colors duration-200">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor" class="w-7 h-7"><path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27s1.36.09 2 .27c1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.01 8.01 0 0 0 16 8c0-4.42-3.58-8-8-8Z" /></svg>
                </a>
            </div>
        </header>

        <nav id="filter-container" class="mb-6 pb-4 border-b border-slate-800 space-y-4 hidden">
             <div>
                <div class="flex items-center gap-2 mb-3">
                     <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 text-slate-400"><path stroke-linecap="round" stroke-linejoin="round" d="M6.75 3v2.25M17.25 3v2.25M3 18.75V7.5a2.25 2.25 0 0 1 2.25-2.25h13.5A2.25 2.25 0 0 1 21 7.5v11.25m-18 0A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75m-18 0h18M-4.5 12h22.5" /></svg>
                    <h2 class="text-base font-semibold text-white">Filter Tanggal</h2>
                </div>
                <div id="date-list-container" class="flex items-center gap-2 overflow-x-auto pb-2"></div>
            </div>
            <div>
                <div class="flex items-center gap-2 mb-3">
                     <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 text-slate-400"><path stroke-linecap="round" stroke-linejoin="round" d="M12 3c2.755 0 5.455.232 8.083.678.533.09.917.556.917 1.096v1.044a2.25 2.25 0 0 1-.659 1.591l-5.432 5.432a2.25 2.25 0 0 0-.659 1.591v2.927a2.25 2.25 0 0 1-1.244 2.013L9.75 21v-6.568a2.25 2.25 0 0 0-.659-1.591L3.659 7.409A2.25 2.25 0 0 1 3 5.818V4.774c0-.54.384-1.006.917-1.096A48.32 48.32 0 0 1 12 3Z" /></svg>
                    <h2 class="text-base font-semibold text-white">Filter Screener</h2>
                </div>
                <div id="screener-filter-container" class="flex items-center gap-2 overflow-x-auto pb-2"></div>
            </div>
        </nav>

        <main id="dashboard-content">
            </main>
    </div>

    <script>
        // =====================================================================
        const SUPABASE_URL = 'https://yvmfenyirwzmgbzzrbfw.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inl2bWZlbnlpcnd6bWdienpyYmZ3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc1ODI0NDIsImV4cCI6MjA3MzE1ODQ0Mn0.i2Yjxa2LZbXEzi6amZpptPAnyLoeAirADdWsW47ZVcA';
        // =====================================================================

        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        const dashboardContent = document.getElementById('dashboard-content');
        const dateListContainer = document.getElementById('date-list-container');
        const screenerFilterContainer = document.getElementById('screener-filter-container');
        const filterContainer = document.getElementById('filter-container');
        const lastUpdatedEl = document.getElementById('last-updated');

        const ITEMS_PER_PAGE = 20;
        let allScreenerData = [], allPriceData = {}, charts = [];
        let selectedDate = null, screenerFilter = null;
        let currentPage = 1, isLoading = false, hasMoreData = true;

        // --- UTILITY FUNCTIONS ---
        const formatCurrency = (val) => val === null || isNaN(val) ? 'N/A' : new Intl.NumberFormat('id-ID').format(val);
        const renderLoader = (c, msg) => { c.innerHTML = `<div class="flex items-center justify-center h-96 bg-slate-800/20 rounded-lg border border-slate-800"><div class="loader ease-linear rounded-full border-4 border-t-4 border-slate-700 h-10 w-10"></div><p class="ml-4 text-slate-400">${msg}</p></div>`; };
        const renderError = (c, msg) => { c.innerHTML = `<div class="bg-red-900/50 border border-red-700 text-red-300 px-4 py-3 rounded-lg"><strong class="font-bold">Error!</strong> ${msg}</div>`; };
        const getDaysHeld = (scanDate) => Math.max(0, Math.floor((new Date() - new Date(scanDate)) / (1000 * 60 * 60 * 24)));

        // --- DATA FETCHING ---
        async function fetchStockData(ticker) {
            if (allPriceData[ticker]) return allPriceData[ticker];
            const url = `${SUPABASE_URL}/functions/v1/yahoo-proxy?ticker=${ticker}`;
            try {
                const res = await fetch(url);
                if (!res.ok) throw new Error(`Proxy error: ${res.status}`);
                const data = await res.json();
                const result = { 
                    price: data.currentPrice ?? null, 
                    dayHigh: data.dayHigh ?? null,
                    name: data.name ?? ticker, 
                    historical: data.historical ?? [] 
                };
                allPriceData[ticker] = result;
                return result;
            } catch (error) { return { price: null, name: ticker, historical: [] }; }
        }

        async function fetchFilters() {
            try {
                const { data: distinctData, error } = await supabaseClient.rpc('get_distinct_screener_filters');
                if (error) throw error;
                const dates = distinctData.distinct_dates.map(item => item.scan_date).sort((a, b) => new Date(b) - new Date(a));
                const screenerNames = distinctData.distinct_screeners.map(item => item.screener_name).sort();
                renderDateList(dates);
                renderScreenerFilters(screenerNames);
                filterContainer.classList.remove('hidden');
            } catch (e) {
                renderError(dashboardContent, `Gagal memuat filter: ${e.message}`);
            }
        }
        
        // --- UI RENDERING ---
        function setupDashboardLayout() {
            dashboardContent.innerHTML = `
                <div id="summary-container" class="mb-6"></div>
                <div class="bg-slate-900 rounded-xl border border-slate-800 overflow-hidden fade-in" style="animation-delay: 200ms;">
                    <div class="p-4 border-b border-slate-800"><h2 id="table-title" class="text-lg font-semibold text-white"></h2></div>
                    <div class="overflow-x-auto">
                        <table class="min-w-full text-xs">
                            <thead class="bg-slate-800/50 text-slate-400 uppercase">
                                <tr class="border-b border-slate-800">
                                    <th class="text-left p-3">Saham</th>
                                    <th class="text-left p-3 hidden lg:table-cell">Screener</th>
                                    <th class="text-right p-3 hidden md:table-cell">Hari</th>
                                    <th class="text-right p-3">Harga Beli</th>
                                    <th class="text-right p-3">Harga Tertinggi</th>
                                    <th class="text-left p-3 hidden sm:table-cell">Trend (3bln)</th>
                                    <th class="text-right p-3">Potensi P/L (%)</th>
                                </tr>
                            </thead>
                            <tbody id="stock-table-body"></tbody>
                        </table>
                    </div>
                </div>
                <div id="load-more-container" class="mt-6 text-center"></div>
            `;
        }

        function renderDateList(dates) {
            const allTimeActive = selectedDate === null;
            const allTimeButton = `<button data-date="all" class="px-4 py-2 rounded-lg border text-sm font-medium transition-all duration-200 shrink-0 ${allTimeActive ? 'bg-emerald-600 text-white border-emerald-500 shadow-lg' : 'bg-slate-800 text-slate-300 border-slate-700 hover:bg-slate-700'}">Semua Waktu</button>`;
            const dateButtons = dates.map(d => `<button data-date="${d}" class="px-4 py-2 rounded-lg border text-sm font-medium transition-all duration-200 shrink-0 ${d === selectedDate ? 'bg-emerald-600 text-white border-emerald-500 shadow-lg' : 'bg-slate-800 text-slate-300 border-slate-700 hover:bg-slate-700'}">${new Date(d).toLocaleDateString('id-ID', { day: '2-digit', month: 'short', year: 'numeric', timeZone: 'Asia/Jakarta' })}</button>`).join('');
            dateListContainer.innerHTML = allTimeButton + dateButtons;
            dateListContainer.querySelectorAll('button').forEach(b => {
                b.addEventListener('click', () => {
                    const selected = b.dataset.date;
                    if (isLoading || selectedDate === selected) return;
                    selectedDate = selected === 'all' ? null : selected;
                    init();
                });
            });
        }
        
        function renderScreenerFilters(screenerNames) {
            const allBtnActive = screenerFilter === null;
            const allBtn = `<button data-screener="all" class="px-4 py-2 rounded-lg border text-sm font-medium transition-all duration-200 shrink-0 ${allBtnActive ? 'bg-emerald-600 text-white border-emerald-500 shadow-lg' : 'bg-slate-800 text-slate-300 border-slate-700 hover:bg-slate-700'}">Semua Screener</button>`;
            const screenerBtns = screenerNames.map(name => `<button data-screener="${name}" class="px-4 py-2 rounded-lg border text-sm font-medium transition-all duration-200 shrink-0 ${name === screenerFilter ? 'bg-emerald-600 text-white border-emerald-500 shadow-lg' : 'bg-slate-800 text-slate-300 border-slate-700 hover:bg-slate-700'}">${name}</button>`).join('');
            screenerFilterContainer.innerHTML = allBtn + screenerBtns;
            screenerFilterContainer.querySelectorAll('button').forEach(b => {
                b.addEventListener('click', () => {
                    const selected = b.dataset.screener;
                    if (isLoading || screenerFilter === selected) return;
                    screenerFilter = selected === 'all' ? null : selected;
                    init();
                });
            });
        }

        function updateSummary() {
            const stats = calculateStats(allScreenerData);
            const summaryData = [ { icon: 'list', label: 'Total Saham', value: stats.total }, { icon: 'chart', label: 'Win Rate', value: `${stats.winRate.toFixed(1)}%`, color: stats.winRate >= 50 ? 'text-emerald-400' : 'text-red-400' }, { icon: 'arrow-up', label: 'Avg. Gain', value: `+${stats.avgGain.toFixed(2)}%`, color: 'text-emerald-400' }, { icon: 'clock', label: 'Avg. Hari', value: `${stats.avgDays.toFixed(0)} hari` }, ];
            const icons = { 'list': '<path d="M8.25 6.75h7.5M8.25 12h7.5m-7.5 5.25h7.5M3.75 6.75h.007v.008H3.75V6.75Zm.375 0a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0ZM3.75 12h.007v.008H3.75V12Zm.375 0a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Zm-.375 5.25h.007v.008H3.75v-.008Zm.375 0a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Z" />', 'chart': '<path d="M3.75 3v11.25A2.25 2.25 0 0 0 6 16.5h12M3.75 3h-1.5m1.5 0h16.5m0 0h1.5m-1.5 0v11.25A2.25 2.25 0 0 1 18 16.5h-12a2.25 2.25 0 0 1-2.25-2.25V3M16.5 7.5l-3.75 3.75-2.25-2.25-4.5 4.5" />', 'arrow-up': '<path d="M2.25 18 9 11.25l4.306 4.306a11.95 11.95 0 0 1 5.814-5.518l2.74-1.22m0 0-5.94-2.28m5.94 2.28L21 21M12 3v18" />', 'clock': '<path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6h4.5m4.5 0a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" />' };
            document.getElementById('summary-container').innerHTML = `<div class="grid grid-cols-2 md:grid-cols-4 gap-4">${summaryData.map(s => `<div class="fade-in bg-slate-900 p-4 rounded-xl border border-slate-800 transition-all duration-300 hover:border-emerald-500/50 hover:bg-slate-800/50 hover:-translate-y-1"><div class="flex items-center gap-4"><div class="text-slate-500"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-7 h-7">${icons[s.icon]}</svg></div><div><p class="text-xs text-slate-400">${s.label}</p><p class="text-2xl font-bold ${s.color || 'text-white'}">${s.value}</p></div></div></div>`).join('')}</div>`;
        }
        
        function appendTableRows(records) {
            const tableBody = document.getElementById('stock-table-body');
            if (!tableBody) return;
            
            const rowsHTML = records.map(r => {
                const { price: cur, dayHigh } = allPriceData[r.stock_code] || {};
                const entry = r.entry_price, days = getDaysHeld(r.scan_date);
                let pnl = 0, cls = 'text-slate-400', icon = 'âˆ’';
                
                // Gunakan dayHigh untuk kalkulasi jika ada, jika tidak, gunakan harga saat ini
                const comparisonPrice = dayHigh || cur;

                if (comparisonPrice && entry) {
                    pnl = ((comparisonPrice - entry) / entry) * 100;
                    if (pnl > 0.01) { cls = 'text-emerald-400'; icon = 'â–²'; } 
                    else if (pnl < -0.01) { cls = 'text-red-400'; icon = 'â–¼'; }
                }
                
                const hasChart = allPriceData[r.stock_code]?.historical?.length > 0;
                return `<tr class="border-b border-slate-800 last:border-b-0 hover:bg-slate-800/50">
                        <td class="p-3"><a href="https://stockbit.com/symbol/${r.stock_code}" target="_blank" class="hover:text-emerald-400"><div class="font-semibold text-white">${r.stock_code}</div></a></td>
                        <td class="p-3 text-slate-400 hidden lg:table-cell">${r.screener_name}</td>
                        <td class="p-3 text-right hidden md:table-cell">${days} hari</td>
                        <td class="p-3 text-right font-mono">${formatCurrency(entry)}</td>
                        
                        <td class="p-3 text-right font-mono">${formatCurrency(dayHigh)}</td>

                        <td class="p-3 w-40 hidden sm:table-cell">${hasChart ? `<div id="sparkline-${r.id}"></div>` : '<div class="text-center text-slate-600 text-xs">No Data</div>'}</td>
                        <td class="p-3 text-right font-semibold ${cls}"><div class="flex items-center justify-end gap-1.5"><span>${icon}</span><span>${pnl.toFixed(2)}%</span></div></td>
                    </tr>`;
            }).join('');

            tableBody.insertAdjacentHTML('beforeend', rowsHTML);

            records.forEach(r => {
                const stockData = allPriceData[r.stock_code];
                if (stockData?.historical?.length > 0) {
                    const isPositive = (stockData.price - r.entry_price) > 0;
                    const options = { series: [{ data: stockData.historical.map(h => h.y) }], chart: { type: 'area', height: 40, sparkline: { enabled: true }}, stroke: { curve: 'smooth', width: 2 }, colors: [isPositive ? '#34d399' : '#f87171'], fill: { type: 'gradient', gradient: { shadeIntensity: 1, opacityFrom: 0.4, opacityTo: 0.1 } }, tooltip: { enabled: false } };
                    const chart = new ApexCharts(document.querySelector(`#sparkline-${r.id}`), options);
                    chart.render();
                    charts.push(chart);
                }
            });
        }
        
        function updateLoadMoreButton() {
            const loadMoreContainer = document.getElementById('load-more-container');
            if (!loadMoreContainer) return;
            
            if (isLoading) {
                 loadMoreContainer.innerHTML = `<div class="flex items-center justify-center"><div class="loader ease-linear rounded-full border-4 border-t-4 border-slate-700 h-8 w-8"></div><p class="ml-3 text-slate-400">Memuat...</p></div>`;
            } else if (hasMoreData) {
                loadMoreContainer.innerHTML = `<button id="load-more-btn" class="bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-2 px-4 rounded-lg transition-colors duration-200">Muat Lebih Banyak</button>`;
                document.getElementById('load-more-btn').addEventListener('click', fetchAndRenderPage);
            } else {
                loadMoreContainer.innerHTML = `<p class="text-slate-500">Sudah mencapai akhir data.</p>`;
            }
        }

        // --- CORE LOGIC ---
        function calculateStats(records) {
            let win = 0, totalPnl = 0, profit = 0, totalDays = 0;
            records.forEach(r => {
                // AMBIL 'dayHigh' JUGA DI SINI
                const { price: cur, dayHigh } = allPriceData[r.stock_code] || {};

                // Gunakan 'dayHigh' sebagai prioritas untuk kalkulasi
                const comparisonPrice = dayHigh || cur;

                if (comparisonPrice && r.entry_price) {
                    const pnl = ((comparisonPrice - r.entry_price) / r.entry_price) * 100;
                    if (pnl > 0.01) { 
                        win++; 
                        profit += pnl; 
                    }
                    totalPnl += pnl; // Anda bisa gunakan ini nanti untuk 'Avg. P/L'
                    totalDays += getDaysHeld(r.scan_date);
                }
            });
            const total = records.length;
            return { 
                total, 
                winRate: total ? win / total * 100 : 0, 
                avgGain: win ? profit / win : 0, 
                avgDays: total ? totalDays / total : 0 
            };
        }

        async function fetchAndRenderPage() {
            if (isLoading || !hasMoreData) return;
            isLoading = true;
            updateLoadMoreButton();

            try {
                const from = (currentPage - 1) * ITEMS_PER_PAGE;
                const to = from + ITEMS_PER_PAGE - 1;

                let query = supabaseClient.from('screener_results').select('*').order('scan_date', { ascending: false }).order('stock_code').range(from, to);

                if (selectedDate) {
                    query = query.eq('scan_date', selectedDate);
                } else {
                    const ninetyDaysAgo = new Date(new Date().setDate(new Date().getDate() - 90)).toISOString().split('T')[0];
                    query = query.gte('scan_date', ninetyDaysAgo);
                }
                
                if (screenerFilter) {
                    query = query.eq('screener_name', screenerFilter);
                }

                const { data, error } = await query;
                if (error) throw error;
                
                if(currentPage === 1) { 
                    const tableBody = document.getElementById('stock-table-body');
                    if(tableBody) tableBody.innerHTML = '';
                }

                hasMoreData = data.length === ITEMS_PER_PAGE;
                await Promise.all(data.map(r => fetchStockData(r.stock_code)));
                allScreenerData.push(...data);
                
                appendTableRows(data);
                updateSummary();
                
                const dateTitle = selectedDate ? new Date(selectedDate).toLocaleDateString('id-ID', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric', timeZone: 'Asia/Jakarta' }) : '90 Hari Terakhir';
                document.getElementById('table-title').innerText = `Hasil Screener - ${screenerFilter || dateTitle}`;

                currentPage++;
            } catch (e) {
                const container = document.getElementById('load-more-container') || dashboardContent;
                renderError(container, e.message);
                console.error("Error fetching page:", e);
            } finally {
                isLoading = false;
                updateLoadMoreButton();
            }
        }
        
        function resetState() {
            charts.forEach(c => c.destroy());
            charts = [];
            allScreenerData = [];
            allPriceData = {};
            currentPage = 1;
            hasMoreData = true;
            isLoading = false;
        }

        async function init() {
            if (isLoading) return;
            isLoading = true;

            resetState();
            setupDashboardLayout();
            renderLoader(document.getElementById('summary-container'), 'Memuat data...');
            document.getElementById('table-title').innerText = 'Hasil Screener';
            
            try {
                await fetchFilters();
                await fetchAndRenderPage();
                lastUpdatedEl.innerText = 'Data dimuat: ' + new Date().toLocaleString('id-ID', { dateStyle: 'long', timeStyle: 'short', timeZone: 'Asia/Jakarta' });
            } catch (e) {
                 renderError(dashboardContent, e.message);
            } finally {
                 isLoading = false;
            }
        }
        
        // --- INITIALIZATION ---
        document.getElementById('refresh-btn').addEventListener('click', init);
        
        document.addEventListener('DOMContentLoaded', () => {
             dashboardContent.innerHTML = `<div class="text-center py-16 bg-slate-800/20 rounded-lg border border-slate-800"><h3 class="text-xl font-semibold text-white">Selamat Datang!</h3><p class="text-slate-400 mt-2">Klik tombol muat ulang di pojok kanan atas untuk memulai analisis.</p></div>`;
        });
    </script>
</body>
</html>
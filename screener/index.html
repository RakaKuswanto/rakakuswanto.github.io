<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Screener Performance Dashboard</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script type="module" src="https://cdn.jsdelivr.net/npm/heroicons@2.1.3/24/outline/index.js"></script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #030712; /* bg-gray-950 */
            color: #d1d5db; /* text-gray-300 */
        }
        .loader {
            border-top-color: #3b82f6; /* border-blue-500 */
            animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        .date-item.active {
            background-color: #1e40af; /* bg-blue-800 */
            color: white;
            font-weight: 600;
        }
        .summary-card {
            background-color: #1f2937; /* bg-gray-800 */
            border: 1px solid #374151; /* border-gray-700 */
        }
        /* Custom scrollbar for better aesthetics */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1f2937; }
        ::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #6b7280; }
    </style>
</head>
<body class="min-h-screen">

    <div class="max-w-screen-2xl mx-auto p-4 sm:p-6 lg:p-8">
        <header class="mb-6 pb-4 border-b border-gray-700/50 flex justify-between items-center">
            <div>
                <h1 class="text-2xl font-bold text-white">Screener Performance Dashboard</h1>
                <p id="last-updated" class="text-sm text-gray-500 mt-1"></p>
            </div>
            <a href="https://github.com" target="_blank" class="text-gray-500 hover:text-white">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor" class="w-6 h-6">
                    <path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27s1.36.09 2 .27c1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.01 8.01 0 0 0 16 8c0-4.42-3.58-8-8-8Z" />
                </svg>
            </a>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-5 gap-6 lg:gap-8">
            
            <aside class="lg:col-span-1 h-full">
                <h2 class="text-base font-semibold text-white mb-3 px-2">Tanggal Screener</h2>
                <div id="date-list-container" class="space-y-1">
                    </div>
            </aside>

            <main id="stock-detail-container" class="lg:col-span-4">
                </main>
        </div>
    </div>

    <script>
        // --- KONFIGURASI ---
        const SUPABASE_URL = 'https://yvmfenyirwzmgbzzrbfw.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inl2bWZlbnlpcnd6bWdienpyYmZ3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc1ODI0NDIsImV4cCI6MjA3MzE1ODQ0Mn0.i2Yjxa2LZbXEzi6amZpptPAnyLoeAirADdWsW47ZVcA'; 
        // -------------------

        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        const dateListContainer = document.getElementById('date-list-container');
        const stockDetailContainer = document.getElementById('stock-detail-container');

        let screenerDataByDate = {};
        let selectedDate = null;

        const formatCurrency = (value, compact = false) => {
            if (value === null || isNaN(value)) return 'N/A';
            const options = compact ? { notation: 'compact', compactDisplay: 'short' } : {};
            return new Intl.NumberFormat('id-ID', options).format(value);
        };

        const renderLoader = (container, message) => {
            container.innerHTML = `<div class="flex items-center justify-center h-96 bg-gray-900/50 rounded-lg border border-gray-800"><div class="loader ease-linear rounded-full border-4 border-t-4 border-gray-700 h-10 w-10"></div><p class="ml-4 text-gray-400">${message}</p></div>`;
        };
        
        const renderError = (container, message) => {
            container.innerHTML = `<div class="bg-red-900/50 border border-red-700 text-red-300 px-4 py-3 rounded-lg" role="alert"><strong class="font-bold">Error!</strong><span class="block sm:inline">${message}</span></div>`;
        };

        async function fetchStockPrice(ticker) {
            const functionUrl = `${SUPABASE_URL}/functions/v1/yahoo-proxy?ticker=${ticker}`;
            try {
                const response = await fetch(functionUrl);
                if (!response.ok) { throw new Error(`Proxy function error! Status: ${response.status}`); }
                const data = await response.json();
                if (data.chart.error) return null;
                return data.chart.result[0].meta.regularMarketPrice;
            } catch (error) {
                console.error(`Gagal mengambil harga untuk ${ticker}:`, error);
                return null;
            }
        }

        function renderDateList(dates) {
            dateListContainer.innerHTML = dates.map(date => {
                const dateObj = new Date(date);
                dateObj.setDate(dateObj.getDate() + 1); // Adjust for UTC interpretation
                const formatted = dateObj.toLocaleDateString('id-ID', { day: '2-digit', month: 'short', year: 'numeric' });
                return `<button data-date="${date}" class="date-item w-full text-left text-sm px-3 py-2 rounded-md transition-colors duration-150 hover:bg-gray-700/80 ${date === selectedDate ? 'active' : ''}">${formatted}</button>`;
            }).join('');

            dateListContainer.querySelectorAll('.date-item').forEach(button => {
                button.addEventListener('click', () => {
                    selectedDate = button.dataset.date;
                    renderDateList(dates);
                    renderStockDetailsForDate(selectedDate);
                });
            });
        }
        
        async function renderStockDetailsForDate(date) {
            renderLoader(stockDetailContainer, 'Memuat detail & harga terkini...');
            const records = screenerDataByDate[date];

            const pricePromises = records.map(r => fetchStockPrice(r.stock_code));
            const currentPrices = await Promise.all(pricePromises);

            let totalProfit = 0, totalLoss = 0, winCount = 0;
            const tableRows = records.map((record, index) => {
                const currentPrice = currentPrices[index];
                const entryPrice = record.entry_price;
                const daysHeld = Math.round((new Date() - new Date(record.scan_date)) / (1000 * 60 * 60 * 24));
                let pnl = 0, pnlRp = 0, pnlClass = 'text-gray-500', pnlIcon = '−';

                if (currentPrice && entryPrice) {
                    pnl = ((currentPrice - entryPrice) / entryPrice) * 100;
                    pnlRp = currentPrice - entryPrice;
                    if (pnl > 0.01) { pnlClass = 'text-green-400'; pnlIcon = '▲'; winCount++; totalProfit += pnl; } 
                    else if (pnl < -0.01) { pnlClass = 'text-red-400'; pnlIcon = '▼'; totalLoss += pnl; }
                }

                return `
                    <tr class="hover:bg-gray-800/50">
                        <td class="p-3 text-xs font-semibold text-white whitespace-nowrap"><a href="https://stockbit.com/symbol/${record.stock_code}" target="_blank" class="hover:text-blue-400">${record.stock_code}</a></td>
                        <td class="p-3 text-xs text-gray-400 whitespace-nowrap">${record.screener_name}</td>
                        <td class="p-3 text-xs text-right font-mono whitespace-nowrap">${daysHeld} hari</td>
                        <td class="p-3 text-xs text-right font-mono whitespace-nowrap">${formatCurrency(entryPrice)}</td>
                        <td class="p-3 text-xs text-right font-mono whitespace-nowrap">${formatCurrency(currentPrice)}</td>
                        <td class="p-3 text-xs text-right font-mono whitespace-nowrap">${formatCurrency(pnlRp)}</td>
                        <td class="p-3 text-xs text-right font-mono font-semibold ${pnlClass} whitespace-nowrap">${pnlIcon} ${pnl.toFixed(2)}%</td>
                    </tr>`;
            }).join('');
            
            const totalTrades = records.length;
            const winRate = totalTrades > 0 ? (winCount / totalTrades) * 100 : 0;
            const avgGain = winCount > 0 ? totalProfit / winCount : 0;
            const avgLoss = (totalTrades - winCount) > 0 ? totalLoss / (totalTrades - winCount) : 0;
            
            const dateObj = new Date(date);
            dateObj.setDate(dateObj.getDate() + 1);
            const formattedDate = dateObj.toLocaleDateString('id-ID', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });

            stockDetailContainer.innerHTML = `
                <div class="space-y-6">
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div class="summary-card p-4 rounded-lg"><p class="text-sm text-gray-400">Total Saham</p><p class="text-2xl font-semibold text-white">${totalTrades}</p></div>
                        <div class="summary-card p-4 rounded-lg"><p class="text-sm text-gray-400">Win Rate</p><p class="text-2xl font-semibold ${winRate >= 50 ? 'text-green-400' : 'text-red-400'}">${winRate.toFixed(1)}%</p></div>
                        <div class="summary-card p-4 rounded-lg"><p class="text-sm text-gray-400">Avg. Gain</p><p class="text-2xl font-semibold text-green-400">+${avgGain.toFixed(2)}%</p></div>
                        <div class="summary-card p-4 rounded-lg"><p class="text-sm text-gray-400">Avg. Loss</p><p class="text-2xl font-semibold text-red-400">${avgLoss.toFixed(2)}%</p></div>
                    </div>

                    <div class="bg-gray-900 rounded-lg border border-gray-800 overflow-hidden">
                        <div class="p-4 border-b border-gray-800"><h2 class="text-lg font-semibold text-white">Hasil Screener - ${formattedDate}</h2></div>
                        <div class="overflow-x-auto">
                            <table class="min-w-full text-xs">
                                <thead class="bg-gray-800/50 text-gray-400 uppercase tracking-wider">
                                    <tr>
                                        <th class="text-left font-semibold p-3">Kode</th>
                                        <th class="text-left font-semibold p-3">Screener</th>
                                        <th class="text-right font-semibold p-3">Hari</th>
                                        <th class="text-right font-semibold p-3">Harga Beli</th>
                                        <th class="text-right font-semibold p-3">Harga Sekarang</th>
                                        <th class="text-right font-semibold p-3">P/L (Rp)</th>
                                        <th class="text-right font-semibold p-3">P/L (%)</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-gray-800">${tableRows}</tbody>
                            </table>
                        </div>
                    </div>
                </div>`;
        }

        async function initializeDashboard() {
            renderLoader(dateListContainer, '');
            renderLoader(stockDetailContainer, 'Mengambil riwayat screener...');

            try {
                const { data, error } = await supabaseClient.from('screener_results').select('*').order('scan_date', { ascending: false });
                if (error) throw error;
                if (!data || data.length === 0) {
                    renderError(stockDetailContainer, "Tidak ada data ditemukan. Pastikan skrip Python Anda sudah berjalan.");
                    dateListContainer.innerHTML = '<p class="text-sm text-gray-500 px-2">Tidak ada data.</p>';
                    return;
                }

                screenerDataByDate = data.reduce((acc, record) => {
                    const date = record.scan_date;
                    if (!acc[date]) acc[date] = [];
                    acc[date].push(record);
                    return acc;
                }, {});

                const uniqueDates = Object.keys(screenerDataByDate).sort((a, b) => new Date(b) - new Date(a));
                
                if (uniqueDates.length > 0) {
                    selectedDate = uniqueDates[0];
                    renderDateList(uniqueDates);
                    renderStockDetailsForDate(selectedDate);
                } else {
                    renderError(stockDetailContainer, "Tidak ada data tanggal yang valid.");
                }

                document.getElementById('last-updated').innerText = `Update Terakhir: ${new Date().toLocaleString('id-ID', { dateStyle: 'long', timeStyle: 'short' })}`;
            } catch (err) {
                renderError(stockDetailContainer, err.message);
                console.error("Error initializing dashboard:", err);
            }
        }
        
        document.addEventListener('DOMContentLoaded', initializeDashboard);
    </script>
</body>
</html>
<!DOCTYPE html>
<html>
<head>
    <title>Grafik Saham Indonesia Dinamis</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script type="text/javascript" src="./charting_library/charting_library.standalone.js"></script>
    <style>
        body { margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif; background-color: #131722; }
        #tv_chart_container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
        .ui-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: none; justify-content: center; align-items: center; background-color: rgba(19, 23, 34, 0.85); z-index: 1000; text-align: center; color: #d1d4dc; }
        .ui-overlay.visible { display: flex; }
        .loader { border: 5px solid #2a2e39; border-top: 5px solid #2962ff; border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        #error-message-box { padding: 20px; background-color: #2a2e39; color: #d1d4dc; border: 1px solid #ff4a4a; border-radius: 8px; max-width: 80%; }
    </style>
</head>
<body>
    <div id="tv_chart_container"></div>
    <div id="loading-overlay" class="ui-overlay visible">
        <div class="loader"></div>
    </div>
    <div id="error-overlay" class="ui-overlay">
        <div id="error-message-box">
            <p><strong>Gagal Memuat Data</strong></p>
            <p id="error-text"></p>
        </div>
    </div>

    <script type="text/javascript">
        document.addEventListener('DOMContentLoaded', function() {
            const loadingOverlay = document.getElementById('loading-overlay');
            const errorOverlay = document.getElementById('error-overlay');
            const errorText = document.getElementById('error-text');

            function showLoader() { loadingOverlay.classList.add('visible'); }
            function hideLoader() { loadingOverlay.classList.remove('visible'); }
            function showError(message) {
                hideLoader();
                let friendlyMessage = message;
                if (message.toLowerCase().includes('failed to fetch') || message.toLowerCase().includes('networkerror')) {
                    friendlyMessage = "Gagal terhubung ke server data. Periksa koneksi internet Anda.";
                } else if (message.includes('404')) {
                    friendlyMessage = "Kode saham tidak ditemukan atau data tidak tersedia.";
                }
                errorText.textContent = friendlyMessage;
                errorOverlay.classList.add('visible');
            }

            const CONFIG = {
                supabaseFunctionUrl: `https://yvmfenyirwzmgbzzrbfw.supabase.co/functions/v1/yahoo-tv-proxy`,
                defaultSymbol: 'BBCA.JK',
            };
            
            const datafeed = {
                onReady: (callback) => {
                    setTimeout(() => callback({ supported_resolutions: ['1', '5', '15', '30', '60', '1D', '1W', '1M'] }), 0);
                },
                resolveSymbol: (symbolName, onSymbolResolvedCallback, onResolveErrorCallback) => {
                    const symbolInfo = {
                        ticker: symbolName,
                        name: symbolName,
                        description: symbolName,
                        type: 'stock',
                        session: '0900-1515',
                        timezone: 'Asia/Jakarta',
                        exchange: 'IDX',
                        minmov: 1,
                        pricescale: 100,
                        has_intraday: true,
                        has_no_volume: false,
                        supported_resolutions: ['1', '5', '15', '30', '60', '1D', '1W', '1M'],
                        format: 'price',
                    };
                    setTimeout(() => onSymbolResolvedCallback(symbolInfo), 0);
                },
                
                searchSymbols: async (userInput, exchange, symbolType, onResultReadyCallback) => {
                    if (userInput.length < 2) {
                        onResultReadyCallback([]);
                        return;
                    }
                    try {
                        const url = new URL(CONFIG.supabaseFunctionUrl);
                        url.searchParams.append('endpoint', 'search');
                        url.searchParams.append('query', userInput);
                        
                        const response = await fetch(url.toString());
                        if (!response.ok) {
                            throw new Error(`Pencarian gagal: ${response.statusText}`);
                        }
                        const results = await response.json();
                        onResultReadyCallback(results);
                    } catch (error) {
                        console.error('Search error:', error);
                        onResultReadyCallback([]);
                    }
                },
                getBars: async (symbolInfo, resolution, periodParams, onHistoryCallback, onErrorCallback) => {
                    showLoader();
                    errorOverlay.classList.remove('visible');

                    const { from, to } = periodParams;
                    
                    const intervalMap = { '1D': '1d', '1W': '1wk', '1M': '1mo' };
                    const interval = intervalMap[resolution] || (/\d+/.test(resolution) ? `${resolution}m` : '1d');
                    
                    const url = new URL(CONFIG.supabaseFunctionUrl);
                    url.searchParams.append('endpoint', 'bars');
                    url.searchParams.append('symbol', symbolInfo.ticker);
                    url.searchParams.append('interval', interval);
                    url.searchParams.append('from', Math.round(from));
                    // --- PERBAIKAN DI SINI ---
                    url.searchParams.append('to', to);
                   
                    try {
                        const response = await fetch(url.toString());
                        if (!response.ok) {
                            const errorData = await response.json().catch(() => null);
                            throw new Error(errorData?.error || `HTTP error! Status: ${response.status}`);
                        }
                        const data = await response.json();
                        
                        if (!data.chart?.result?.length || data.chart.error) {
                            onHistoryCallback([], { noData: true }); 
                            return;
                        }

                        const result = data.chart.result[0];
                        const quotes = result.indicators.quote[0];
                        if (!result.timestamp || !quotes?.open) {
                            onHistoryCallback([], { noData: true }); 
                            return;
                        }
                        
                        const bars = result.timestamp
                            .map((ts, index) => ({
                                time: ts * 1000,
                                open: quotes.open[index],
                                high: quotes.high[index],
                                low: quotes.low[index],
                                close: quotes.close[index],
                                volume: quotes.volume[index],
                            }))
                            .filter(bar => bar.open !== null && bar.high !== null && bar.low !== null && bar.close !== null);
                        
                        onHistoryCallback(bars, { noData: bars.length === 0 });

                    } catch (error) {
                        onErrorCallback(error.message);
                        showError(error.message);
                    } finally {
                        hideLoader();
                    }
                },
                subscribeBars: () => {},
                unsubscribeBars: () => {},
            };
            
            const widget = new TradingView.widget({
                container: 'tv_chart_container',
                library_path: './charting_library/',
                datafeed: datafeed,
                locale: 'id',
                symbol: CONFIG.defaultSymbol,
                interval: '1D',
                theme: 'Dark',
                autosize: true,
                
                enabled_features: [
                    'side_toolbar_in_fullscreen_mode',
                    'allow_symbol_change',
                ],
                disabled_features: [
                    'use_localstorage_for_settings',
                    'study_templates',
                    'header_compare',
                ],
                
                timezone: 'Asia/Jakarta',
                details: true,
                hotkeys: true,
                
                overrides: {
                    "paneProperties.background": "#131722",
                    "paneProperties.vertGridProperties.color": "#2a2e39",
                    "paneProperties.horzGridProperties.color": "#2a2e39",
                    "symbolWatermarkProperties.transparency": 90,
                    "scalesProperties.textColor" : "#d1d4dc",
                    "mainSeriesProperties.candleStyle.upColor": "#26a69a",
                    "mainSeriesProperties.candleStyle.downColor": "#ef5350",
                    "mainSeriesProperties.candleStyle.wickUpColor": "#26a69a",
                    "mainSeriesProperties.candleStyle.wickDownColor": "#ef5350",
                    "mainSeriesProperties.candleStyle.borderUpColor": "#26a69a",
                    "mainSeriesProperties.candleStyle.borderDownColor": "#ef5350",
                }
            });
        });
    </script>
</body>
</html>